# v1.2.8 ä¿®å¤çª—å£å›¾æ ‡æ˜¾ç¤ºé—®é¢˜

## ä¿®å¤å†…å®¹

ä¿®å¤äº† Windows æ‰“åŒ…åº”ç”¨ä¸­çª—å£æ ‡é¢˜æ å’Œä»»åŠ¡æ å›¾æ ‡æ˜¾ç¤ºä¸æ­£ç¡®çš„é—®é¢˜ã€‚

## é—®é¢˜æè¿°

åœ¨ Windows æ‰“åŒ…åçš„åº”ç”¨ä¸­ï¼Œçª—å£æ ‡é¢˜æ å’Œä»»åŠ¡æ æ˜¾ç¤ºçš„æ˜¯é€šç”¨æ–‡æ¡£å›¾æ ‡ï¼ˆğŸ“„ï¼‰ï¼Œè€Œä¸æ˜¯è‡ªå®šä¹‰çš„åº”ç”¨å›¾æ ‡ã€‚

## æ ¹æœ¬åŸå› 

**å…³é”®é—®é¢˜**ï¼šå›¾æ ‡æ–‡ä»¶è¢«æ‰“åŒ…è¿›äº† `app.asar` å†…éƒ¨ï¼Œè€Œè¿è¡Œæ—¶ä»£ç å°è¯•ä» `resources` ç›®å½•å¤–éƒ¨åŠ è½½å›¾æ ‡ã€‚

å…·ä½“è¡¨ç°ï¼š
- åº”ç”¨è·¯å¾„ï¼š`C:\Users\...\resources\app.asar`ï¼ˆasar å‹ç¼©åŒ…ï¼‰
- ä»£ç å°è¯•åŠ è½½ï¼š`C:\Users\...\resources\build\icon.ico`ï¼ˆasar å¤–éƒ¨ï¼‰
- ç»“æœï¼šIcon exists: falseï¼ˆæ–‡ä»¶ä¸å­˜åœ¨ï¼‰

electron-builder çš„ `files` é…ç½®ä¼šæŠŠæ–‡ä»¶æ‰“åŒ…è¿› `app.asar`ï¼Œä½†å›¾æ ‡æ–‡ä»¶éœ€è¦åœ¨ asar å¤–éƒ¨æ‰èƒ½è¢« `nativeImage.createFromPath()` æ­£ç¡®åŠ è½½ã€‚

## ä¿®å¤æ–¹æ¡ˆ

### 1. ä¿®å¤æ‰“åŒ…é…ç½®ï¼ˆå…³é”®ï¼‰

ä½¿ç”¨ `extraResources` è€Œä¸æ˜¯ `files` æ¥åŒ…å«å›¾æ ‡æ–‡ä»¶ï¼š

```json
"extraResources": [
  {
    "from": "build",
    "to": "build",
    "filter": ["**/*"]
  }
]
```

**ä¸ºä»€ä¹ˆä½¿ç”¨ extraResourcesï¼Ÿ**
- `files` é…ç½®çš„æ–‡ä»¶ä¼šè¢«æ‰“åŒ…è¿› `app.asar` å‹ç¼©åŒ…å†…
- `extraResources` é…ç½®çš„æ–‡ä»¶ä¼šè¢«æ”¾åœ¨ `resources` ç›®å½•ä¸‹ï¼Œåœ¨ asar å¤–éƒ¨
- `nativeImage.createFromPath()` éœ€è¦è®¿é—®çœŸå®çš„æ–‡ä»¶ç³»ç»Ÿè·¯å¾„ï¼Œä¸èƒ½è¯»å– asar å†…éƒ¨çš„æ–‡ä»¶
- å› æ­¤å›¾æ ‡æ–‡ä»¶å¿…é¡»æ”¾åœ¨ asar å¤–éƒ¨

### 2. ä¼˜åŒ–å›¾æ ‡è·¯å¾„é€»è¾‘

ä¿®æ”¹äº† `src/main/main.ts` ä¸­çš„å›¾æ ‡è·¯å¾„è®¡ç®—é€»è¾‘ï¼š

- **å¼€å‘æ¨¡å¼**ï¼šä½¿ç”¨ `app.getAppPath()` è·å–åº”ç”¨æ ¹ç›®å½•
- **ç”Ÿäº§æ¨¡å¼**ï¼šä»æ‰“åŒ…åçš„ `resources` ç›®å½•è¯»å–å›¾æ ‡
- **å¹³å°é€‚é…**ï¼š
  - Windows: ä½¿ç”¨ `.ico` æ ¼å¼
  - macOS: ä½¿ç”¨ `.icns` æ ¼å¼
  - Linux: ä½¿ç”¨ `.png` æ ¼å¼

### 3. ä½¿ç”¨ nativeImage åŠ è½½å›¾æ ‡

æ”¹ç”¨ Electron çš„ `nativeImage` API æ¥åŠ è½½å›¾æ ‡ï¼š

```typescript
const icon = nativeImage.createFromPath(iconPath);
mainWindow = new BrowserWindow({
  icon: icon,
  // ...
});
```

### 4. å¹³å°ç‰¹æ®Šå¤„ç†

åœ¨ä¸åŒå¹³å°ä¸Šä½¿ç”¨ä¸åŒçš„å›¾æ ‡è®¾ç½®ç­–ç•¥ï¼š

```typescript
if (process.platform === 'linux') {
  mainWindow.setIcon(icon);
  if (!icon.isEmpty()) {
    try {
      app.setIcon(icon);
    } catch (e) {
      console.log('Failed to set app icon:', e);
    }
  }
} else if (process.platform === 'win32') {
  mainWindow.setIcon(icon);
}
```

### 5. æ·»åŠ çª—å£æ ‡é¢˜

æ˜¾å¼è®¾ç½®çª—å£æ ‡é¢˜ä¸º"æ—¥æŠ¥åŠ©æ‰‹"ã€‚

### 6. å¢å¼ºè°ƒè¯•æ—¥å¿—

æ·»åŠ è¯¦ç»†çš„è°ƒè¯•ä¿¡æ¯ï¼š
- åº”ç”¨è·¯å¾„ (`app.getAppPath()`)
- å¹³å°ä¿¡æ¯
- å›¾æ ‡è·¯å¾„
- æ–‡ä»¶å­˜åœ¨æ€§
- å›¾æ ‡åŠ è½½çŠ¶æ€
- å›¾æ ‡å°ºå¯¸

## æŠ€æœ¯ç»†èŠ‚

```typescript
// å¯¼å…¥ nativeImage
const { app, BrowserWindow, ipcMain, nativeImage } = require('electron');

// å¼€å‘æ¨¡å¼ä½¿ç”¨ app.getAppPath()
if (process.env.NODE_ENV === 'development') {
  const appPath = app.getAppPath();
  iconPath = path.join(appPath, 'build/icon.ico');
}

// åŠ è½½å›¾æ ‡
const icon = nativeImage.createFromPath(iconPath);
console.log('Icon loaded:', !icon.isEmpty());
if (!icon.isEmpty()) {
  console.log('Icon size:', icon.getSize());
}

// åˆ›å»ºçª—å£
mainWindow = new BrowserWindow({
  icon: icon,
  title: 'æ—¥æŠ¥åŠ©æ‰‹',
  // ...
});

// å¹³å°ç‰¹æ®Šå¤„ç†
mainWindow.setIcon(icon);
```

## å½±å“èŒƒå›´

- çª—å£æ ‡é¢˜æ å›¾æ ‡æ˜¾ç¤º
- ä»»åŠ¡æ å›¾æ ‡æ˜¾ç¤º
- åº”ç”¨åˆ‡æ¢å™¨ä¸­çš„å›¾æ ‡æ˜¾ç¤º
- Windows ä»»åŠ¡æ é¢„è§ˆå›¾æ ‡

## æµ‹è¯•æ­¥éª¤

### 1. é‡æ–°æ‰“åŒ…åº”ç”¨

```bash
npm run build
npm run package:win
```

### 2. æµ‹è¯•æ‰“åŒ…åçš„åº”ç”¨

åœ¨ `release` ç›®å½•ä¸­æ‰¾åˆ°æ‰“åŒ…å¥½çš„å®‰è£…ç¨‹åºæˆ–å¯æ‰§è¡Œæ–‡ä»¶ï¼Œåœ¨ Windows ä¸Šå®‰è£…/è¿è¡Œã€‚

### 3. éªŒè¯å›¾æ ‡æ–‡ä»¶ä½ç½®

æ‰“åŒ…åçš„æ–‡ä»¶ç»“æ„åº”è¯¥æ˜¯ï¼š
```
DailyReport/
â”œâ”€â”€ resources/
â”‚   â”œâ”€â”€ app.asar          # åº”ç”¨ä»£ç ï¼ˆå‹ç¼©åŒ…ï¼‰
â”‚   â””â”€â”€ build/            # å›¾æ ‡æ–‡ä»¶ï¼ˆåœ¨ asar å¤–éƒ¨ï¼‰
â”‚       â””â”€â”€ icon.ico
â””â”€â”€ DailyReport.exe
```

### 4. æŸ¥çœ‹è°ƒè¯•æ—¥å¿—ï¼ˆå¯é€‰ï¼‰

æ—¥å¿—æ–‡ä»¶ä½ç½®ï¼š`%APPDATA%\DailyReport\icon-debug.log`

åº”è¯¥çœ‹åˆ°ï¼š
- Icon path: `C:\...\resources\build\icon.ico`
- Icon exists: true
- Icon loaded: true

## å¼€å‘ç¯å¢ƒè¯´æ˜

- **å¼€å‘ç¯å¢ƒ**ï¼šLinux
- **ç›®æ ‡ç¯å¢ƒ**ï¼šWindows
- **è·¨å¹³å°æ‰“åŒ…**ï¼šåœ¨ Linux ä¸Šä½¿ç”¨ electron-builder æ‰“åŒ… Windows åº”ç”¨

## ç‰ˆæœ¬ä¿¡æ¯

- ç‰ˆæœ¬å·ï¼šv1.2.8
- å‘å¸ƒæ—¥æœŸï¼š2026-02-24
