# v1.2.3 自动迁移日报文件

## 问题描述

用户反馈详情页 404：`https://enneket.github.io/daily/docs/2026/02/12.html`

经检查发现：
1. 日报文件目前存储在 `docs/2026/02/12.md`（旧位置）
2. 桌面应用代码已改为 `site/docs/`（新位置，v1.2.2）
3. VitePress 只构建 `site/` 目录下的文件
4. 导致旧位置的日报文件无法被 VitePress 处理，访问详情页时出现 404

## 根本原因

虽然桌面应用的代码已经更新（v1.2.2），但：
- 用户的日报仓库中已有的日报文件还在旧位置 `docs/`
- 需要将这些文件迁移到 `site/docs/`
- 之前的版本没有提供自动迁移功能

## 解决方案

在桌面应用初始化时自动检测并迁移旧的日报文件。

### 实现方式

1. **检测旧文件**：检查 `docs/` 目录是否存在年份目录（如 `2026/`）
2. **递归扫描**：扫描所有日报 Markdown 文件
3. **迁移文件**：将文件从 `docs/` 复制到 `site/docs/`，保持目录结构
4. **删除旧文件**：迁移成功后删除旧位置的文件

## 技术实现

### 1. 新增迁移方法

**文件**：`src/main/github-service.ts`

添加 `migrateOldReports()` 方法：

```typescript
private async migrateOldReports(): Promise<void> {
  // 1. 检查 docs/ 目录是否存在
  // 2. 检查是否包含年份目录（日报文件）
  // 3. 递归扫描所有 .md 文件
  // 4. 逐个迁移文件到 site/docs/
  // 5. 删除旧文件
}
```

**关键点**：
- 使用箭头函数避免 `this` 绑定问题
- 使用 GitHub API 进行文件操作
- 错误处理：404 表示目录不存在，无需迁移

### 2. 集成到初始化流程

在 `updateRepoFiles()` 方法开始时调用迁移：

```typescript
private async updateRepoFiles(filesToUpdate: string[]): Promise<void> {
  console.log(`开始更新日报仓库，共 ${filesToUpdate.length} 个文件...`);
  
  // 检查并迁移旧的日报文件
  await this.migrateOldReports();
  
  // ... 继续更新其他文件
}
```

### 3. 新增迁移脚本

**文件**：`scripts/migrate-reports.js`

提供独立的迁移脚本，可以在本地运行：

```bash
node scripts/migrate-reports.js
```

功能：
- 检查本地 `docs/` 目录
- 复制文件到 `site/docs/`
- 删除旧目录

## 迁移流程

### 自动迁移（推荐）

1. 用户打开桌面应用
2. 点击"保存并初始化"
3. 应用自动检测旧文件
4. 如果发现旧文件，自动迁移
5. 迁移完成后继续更新其他文件

### 手动迁移（备选）

如果自动迁移失败，用户可以手动操作：

```bash
# 在日报仓库中执行
mkdir -p site/docs
cp -r docs/* site/docs/
rm -rf docs
git add .
git commit -m "Migrate reports to site/docs/"
git push
```

## 迁移示例

### 迁移前
```
仓库根目录/
├── docs/
│   └── 2026/
│       └── 02/
│           └── 12.md
└── site/
    ├── .vitepress/
    └── index.md
```

### 迁移后
```
仓库根目录/
└── site/
    ├── .vitepress/
    ├── docs/          # 新位置
    │   └── 2026/
    │       └── 02/
    │           └── 12.md
    └── index.md
```

## 版本更新

- 版本号：v1.2.3
- 更新内容：
  - 添加 `migrateOldReports()` 方法
  - 在初始化时自动迁移旧文件
  - 新增 `scripts/migrate-reports.js` 脚本
  - 更新 FILE_VERSIONS 包含迁移脚本

## 修改的文件

- `src/main/github-service.ts` - 添加迁移方法和调用
- `scripts/migrate-reports.js` - 新建迁移脚本
- `plans/2026-02-12-日报文件迁移方案.md` - 迁移方案文档

## 使用方法

### 对于新用户
直接使用 v1.2.3 版本，不会遇到此问题。

### 对于已有日报的用户
1. 更新桌面应用到 v1.2.3
2. 打开应用，点击"保存并初始化"
3. 应用会自动检测并迁移旧文件
4. 查看控制台日志确认迁移成功
5. 等待 GitHub Actions 构建完成
6. 访问详情页验证：`https://你的用户名.github.io/仓库名/docs/2026/02/12`

## 验证清单

- [ ] 旧文件被正确识别
- [ ] 文件迁移到 `site/docs/` 目录
- [ ] 目录结构保持不变
- [ ] 旧文件被删除
- [ ] GitHub Actions 构建成功
- [ ] 详情页可以正常访问
- [ ] 日历/归档页面显示正常

## 注意事项

### 迁移时间
- 迁移时间取决于日报数量
- 每个文件需要 2 次 API 调用（创建+删除）
- GitHub API 有速率限制（5000 次/小时）

### 错误处理
- 如果迁移失败，不会影响其他文件更新
- 失败的文件会在控制台显示错误信息
- 可以重新运行初始化来重试

### 幂等性
- 迁移操作是幂等的
- 如果 `site/docs/` 已存在文件，会覆盖
- 如果 `docs/` 不存在，直接跳过

## 相关文档

- [v1.2.2 修复日报详情页 404 问题](./v1.2.2修复日报详情页404问题.md)
- [日报文件迁移方案](../plans/2026-02-12-日报文件迁移方案.md)
- [完整使用流程](./完整使用流程.md)

## 后续优化

可能的改进方向：
1. 显示迁移进度条
2. 批量操作减少 API 调用
3. 迁移前备份
4. 迁移后验证文件完整性
