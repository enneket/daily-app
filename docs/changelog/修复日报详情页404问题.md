# v1.2.2 修复日报详情页 404 问题

## 问题描述

访问日报详情页时出现 404 错误：
- 访问地址：`https://enneket.github.io/daily/docs/2026/02/12.html`
- 错误：`PAGE NOT FOUND`

## 根本原因

日报文件存储在 `docs/` 目录，但 VitePress 只构建 `site/` 目录下的文件。

### 目录结构问题

**之前的结构**：
```
仓库根目录/
├── docs/              # 日报存储目录
│   └── 2026/
│       └── 02/
│           └── 12.md
├── site/              # VitePress 源目录
│   ├── .vitepress/
│   ├── index.md
│   └── ...
└── scripts/
```

**问题**：
- VitePress 默认只构建 `site/` 目录
- `docs/` 目录下的文件不会被 VitePress 处理
- 导致访问 `/docs/2026/02/12.html` 时找不到文件

## 解决方案

将日报存储路径从 `docs/` 改为 `site/docs/`，让 VitePress 能够处理这些文件。

### 新的目录结构

```
仓库根目录/
├── site/              # VitePress 源目录
│   ├── .vitepress/
│   ├── docs/          # 日报存储目录（新位置）
│   │   └── 2026/
│   │       └── 02/
│   │           └── 12.md
│   ├── index.md
│   └── ...
└── scripts/
```

## 技术细节

### 修改 1：桌面应用的日报存储路径

**文件**：`src/main/github-service.ts`

**修改前**：
```typescript
private generateFilePath(date: Date): string {
  const year = date.getFullYear();
  const month = String(date.getMonth() + 1).padStart(2, '0');
  const day = String(date.getDate()).padStart(2, '0');
  return `docs/${year}/${month}/${day}.md`;
}
```

**修改后**：
```typescript
private generateFilePath(date: Date): string {
  const year = date.getFullYear();
  const month = String(date.getMonth() + 1).padStart(2, '0');
  const day = String(date.getDate()).padStart(2, '0');
  return `site/docs/${year}/${month}/${day}.md`;
}
```

### 修改 2：索引生成脚本的扫描路径

**文件**：`scripts/generate-index.js`

**修改前**：
```javascript
const reportsDir = 'docs';
```

**修改后**：
```javascript
const reportsDir = 'site/docs';
```

### 路径引用保持不变

索引中的 `path` 字段保持为 `/docs/2026/02/12`，因为：
- VitePress 的 base 是 `/daily/`
- 最终 URL 是：`https://enneket.github.io/daily/docs/2026/02/12.html`
- VitePress 会自动处理 `site/docs/` 目录下的文件

## VitePress 的工作原理

### 构建过程

1. **源目录**：VitePress 读取 `site/` 目录下的所有 `.md` 文件
2. **处理文件**：将 Markdown 转换为 HTML
3. **输出目录**：生成到 `site/.vitepress/dist/` 目录
4. **保持结构**：输出目录保持与源目录相同的结构

### 路径映射

| 源文件 | 输出文件 | 访问 URL |
|--------|----------|----------|
| `site/index.md` | `dist/index.html` | `/daily/` |
| `site/calendar.md` | `dist/calendar.html` | `/daily/calendar.html` |
| `site/docs/2026/02/12.md` | `dist/docs/2026/02/12.html` | `/daily/docs/2026/02/12.html` |

## 迁移说明

### 对于新用户

使用 v1.2.2 或更高版本的桌面应用，日报会自动存储到正确的位置。

### 对于已有日报的用户

如果你已经有日报存储在 `docs/` 目录：

**选项 1：手动迁移（推荐）**
```bash
# 在日报仓库中执行
mkdir -p site/docs
mv docs/* site/docs/
rmdir docs
```

**选项 2：重新提交**
- 使用新版本桌面应用
- 重新提交所有日报
- 旧的日报会保留在 `docs/` 目录（可以手动删除）

## 使用方法

1. **重新打包桌面应用**（v1.2.2）
2. **运行应用，保存配置**（会更新 `generate-index.js`）
3. **迁移已有日报**（如果有）
4. **提交新日报测试**
5. **验证详情页可以访问**

## 验证清单

- [ ] 提交新日报成功
- [ ] 日报文件存储在 `site/docs/YYYY/MM/DD.md`
- [ ] 索引生成成功
- [ ] 日历/归档页面显示新日报
- [ ] 点击日报链接可以访问详情页
- [ ] 详情页内容正确显示

## 注意事项

### .gitignore 配置

确保 `.gitignore` 不会忽略 `site/docs/` 目录：

```gitignore
# 正确的配置
node_modules
site/.vitepress/dist
site/.vitepress/cache
site/.vitepress/reports-index.json
site/.vitepress/stats.json
.DS_Store

# 不要添加这一行！
# site/docs/
```

### GitHub Actions 触发

workflow 配置中的 `paths` 已经包含 `**.md`，会自动触发构建：

```yaml
on:
  push:
    branches: [main]
    paths:
      - '**.md'  # 包括 site/docs/**/*.md
      - '.github/workflows/deploy-site.yml'
      - 'scripts/**'
      - 'site/**'
```

## 修改的文件

- `src/main/github-service.ts` - 修改日报存储路径
- `scripts/generate-index.js` - 修改扫描路径
- `src/renderer/components/Settings.tsx` - 更新版本号显示

## 版本历史

### v1.2.2 (2026-02-12)
- 修改日报存储路径从 `docs/` 到 `site/docs/`
- 修复日报详情页 404 问题
- 更新索引生成脚本扫描路径

### v1.2.1 (2026-02-12)
- 修复统计页面对象遍历问题

### v1.2.0 (2026-02-12)
- 简化页面实现

## 相关文档

- [v1.2.1 修复统计页面对象遍历问题](./v1.2.1修复统计页面对象遍历问题.md)
- [v1.2.0 简化页面实现](./v1.2.0简化页面实现.md)
- [完整使用流程](./完整使用流程.md)
