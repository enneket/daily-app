# v1.2.1 修复统计页面对象遍历问题

## 问题描述

v1.2.0 简化了页面实现，但统计页面仍然显示原始模板代码：

```html
<div class="stat-card">
  <div class="stat-value">1</div>
  <div class="stat-label">今年日报</div>
</div>
```

## 根本原因

在 `stats.md` 中使用了 `v-for` 遍历对象：

```vue
<div v-for="(count, year) in safeStats.byYear" :key="year">
  <!-- ... -->
</div>
```

VitePress 的 SSR 在处理 `v-for` 遍历对象时可能存在问题，导致模板无法正确渲染。

## 解决方案

将对象转换为数组，然后使用 `v-for` 遍历数组：

### 修改前

```vue
<script setup>
const safeStats = stats || {
  byYear: {},
  byMonth: {}
};
</script>

<div v-for="(count, year) in safeStats.byYear" :key="year">
  <div>{{ year }} 年</div>
  <div>{{ count }} 篇</div>
</div>
```

### 修改后

```vue
<script setup>
const safeStats = stats || {
  byYear: {},
  byMonth: {}
};

// 将对象转换为数组
const yearStatsArray = Object.entries(safeStats.byYear || {})
  .map(([year, count]) => ({ year, count }))
  .sort((a, b) => b.year.localeCompare(a.year));

const monthStatsArray = Object.entries(safeStats.byMonth || {})
  .map(([month, count]) => ({ month, count }))
  .sort((a, b) => b.month.localeCompare(a.month));
</script>

<div v-for="item in yearStatsArray" :key="item.year">
  <div>{{ item.year }} 年</div>
  <div>{{ item.count }} 篇</div>
</div>
```

## 技术细节

### 为什么遍历对象有问题？

在 Vue 3 中，`v-for` 可以遍历对象，但在 VitePress 的 SSR 环境中：

1. **对象属性顺序不确定**：JavaScript 对象的属性顺序在不同环境中可能不同
2. **SSR 和客户端不一致**：服务器端和客户端的遍历顺序可能不同，导致 hydration 失败
3. **类型推断问题**：TypeScript 对对象遍历的类型推断可能不准确

### 使用数组的优势

1. **顺序确定**：数组的顺序是明确的
2. **SSR 友好**：服务器端和客户端的行为一致
3. **类型安全**：TypeScript 能更好地推断数组元素的类型
4. **可排序**：可以使用 `.sort()` 方法自定义排序

### Object.entries() 方法

`Object.entries()` 将对象转换为键值对数组：

```javascript
const obj = { a: 1, b: 2, c: 3 };
const entries = Object.entries(obj);
// [['a', 1], ['b', 2], ['c', 3]]

const array = entries.map(([key, value]) => ({ key, value }));
// [{ key: 'a', value: 1 }, { key: 'b', value: 2 }, { key: 'c', value: 3 }]
```

## 其他改进

### 添加条件渲染

为了避免空数据时显示空白区域，添加了 `v-if` 条件：

```vue
<h2 v-if="yearStatsArray.length > 0">按年统计</h2>
<div class="year-stats" v-if="yearStatsArray.length > 0">
  <!-- ... -->
</div>
```

### 预计算布尔值

将复杂的条件表达式预计算为变量：

```vue
<script setup>
const hasTimeRange = safeStats.firstDate && safeStats.lastDate;
</script>

<h2 v-if="hasTimeRange">时间跨度</h2>
<div class="time-range" v-if="hasTimeRange">
  <!-- ... -->
</div>
```

## 使用方法

1. **重新打包桌面应用**（v1.2.1）
2. **运行应用，保存配置**（会更新 stats.md）
3. **等待构建完成**
4. **访问统计页面验证**

## 验证清单

- [ ] 统计页面正常显示（无原始模板代码）
- [ ] 总日报数等基础统计正确显示
- [ ] 按年统计的进度条正常显示
- [ ] 按月统计的网格正常显示
- [ ] 时间跨度信息正确显示

## 最佳实践

在 VitePress 中使用 Vue 组件时：

1. **避免遍历对象**：始终将对象转换为数组后再遍历
2. **预处理数据**：在 `<script setup>` 中完成所有数据转换
3. **使用简单的模板**：避免复杂的计算和条件
4. **添加安全检查**：使用 `v-if` 避免访问不存在的数据
5. **测试 SSR**：使用 `npm run build:site` 和 `npm run preview:site` 测试

## 修改的文件

- `site/stats.md` - 将对象转换为数组，添加条件渲染
- `src/main/github-service.ts` - 更新版本号到 1.2.1
- `src/renderer/components/Settings.tsx` - 更新显示版本号

## 版本历史

### v1.2.1 (2026-02-12)
- 修复统计页面对象遍历问题
- 将 byYear 和 byMonth 对象转换为数组
- 添加条件渲染避免空白区域

### v1.2.0 (2026-02-12)
- 简化日历、归档、统计页面实现
- 移除复杂的客户端交互

## 相关文档

- [v1.2.0 简化页面实现](./v1.2.0简化页面实现.md)
- [修复 VitePress 页面渲染问题计划](../plans/2026-02-12-修复VitePress页面渲染问题.md)
