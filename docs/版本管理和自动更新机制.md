# 版本管理和自动更新机制

## 概述

从 v1.1.0 开始，桌面应用引入了版本管理机制，能够自动检测并更新日报仓库中的过期文件，解决了之前需要手动删除文件才能更新的问题。

## 问题背景

在 v1.1.0 之前，桌面应用存在以下问题：

1. **文件版本不同步**：桌面应用仓库的文件已更新（添加了安全检查、默认值等），但已初始化的日报仓库仍使用旧版本文件
2. **无更新机制**：只检查文件是否存在，不检查文件版本，导致旧文件永远不会被更新
3. **用户体验差**：用户需要手动删除文件才能触发重新初始化
4. **构建错误**：旧版本文件导致日报仓库构建失败，报错 `Cannot read properties of undefined (reading 'day')`

## 解决方案

### 版本文件机制

在日报仓库根目录创建 `.daily-version.json` 文件来追踪版本：

```json
{
  "version": "1.1.0",
  "updatedAt": "2026-02-12T10:00:00Z",
  "files": {
    "site/.vitepress/config.ts": "1.1.0",
    "site/.vitepress/reports-index.data.ts": "1.1.0",
    "site/.vitepress/stats.data.ts": "1.1.0",
    "site/.vitepress/reports-index.json": "1.1.0",
    "site/.vitepress/stats.json": "1.1.0",
    "site/index.md": "1.1.0",
    "site/calendar.md": "1.1.0",
    "site/archive.md": "1.1.0",
    "site/stats.md": "1.1.0",
    "site/latest.md": "1.1.0",
    "scripts/generate-index.js": "1.1.0",
    "package.json": "1.1.0",
    ".gitignore": "1.0.0",
    ".github/workflows/deploy-site.yml": "1.0.0",
    "README.md": "1.0.0"
  }
}
```

### 智能更新流程

保存配置时，应用会自动执行以下流程：

```
保存配置
  ↓
测试连接
  ↓
检查版本文件
  ↓
比较版本
  ├─ 版本文件不存在 → 完整初始化所有文件
  ├─ 整体版本不匹配 → 更新所有文件
  ├─ 部分文件版本不匹配 → 只更新过期文件
  └─ 版本完全匹配 → 跳过更新
  ↓
显示结果反馈
```

### 用户反馈

根据不同情况显示不同的反馈消息：

- **首次初始化**：`配置已保存，仓库初始化完成！请在 GitHub 设置中启用 Pages。`
- **更新文件**：`配置已保存！已更新 X 个文件到最新版本 (v1.1.0)。`
- **无需更新**：`配置已保存！仓库已是最新版本 (v1.1.0)，无需更新。`

## 技术实现

### 核心代码变更

#### 1. 添加版本常量（`src/main/github-service.ts`）

```typescript
private readonly CURRENT_VERSION = '1.1.0';
private readonly FILE_VERSIONS: Record<string, string> = {
  'site/.vitepress/config.ts': '1.1.0',
  'site/calendar.md': '1.1.0',
  // ... 其他文件
};
```

#### 2. 实现版本检查方法

```typescript
private async checkVersion(): Promise<{ 
  needsUpdate: boolean; 
  outdatedFiles: string[] 
}> {
  // 读取远程版本文件
  // 比较版本号
  // 返回需要更新的文件列表
}
```

#### 3. 修改初始化方法

```typescript
async testConnectionAndInitialize(): Promise<{ 
  initialized: boolean; 
  skipped: boolean;
  updated: boolean;
  updatedFiles: string[];
}> {
  await this.testConnection();
  const { needsUpdate, outdatedFiles } = await this.checkVersion();
  
  if (needsUpdate) {
    await this.updateRepoFiles(outdatedFiles);
    return { initialized: true, skipped: false, updated: true, updatedFiles: outdatedFiles };
  }
  
  return { initialized: false, skipped: true, updated: false, updatedFiles: [] };
}
```

#### 4. 实现文件更新方法

```typescript
private async updateRepoFiles(filesToUpdate: string[]): Promise<void> {
  // 只更新需要的文件
  // 获取现有文件的 SHA（避免冲突）
  // 更新版本文件
}
```

### 修改的文件

1. **`src/main/github-service.ts`**
   - 添加版本常量 `CURRENT_VERSION` 和 `FILE_VERSIONS`
   - 实现 `checkVersion()` 方法
   - 修改 `testConnectionAndInitialize()` 返回值
   - 实现 `updateRepoFiles()` 方法
   - 废弃 `checkRepoInitialized()` 方法

2. **`src/main/main.ts`**
   - 更新 `save-config` handler 返回更多信息
   - 传递 `updated` 和 `updatedFiles` 字段

3. **`src/renderer/components/Settings.tsx`**
   - 更新 `handleSave()` 方法
   - 根据不同结果显示不同的反馈消息
   - 显示更新的文件数量和版本号

## 使用说明

### 对于用户

1. **首次使用**：
   - 打开桌面应用
   - 配置 GitHub 信息
   - 点击"保存并初始化"
   - 应用会自动创建所有必需的文件和版本文件

2. **已有旧版本仓库**：
   - 打开桌面应用
   - 点击"保存并初始化"（即使已经配置过）
   - 应用会自动检测并更新过期的文件
   - 查看反馈消息确认更新成功

3. **日常使用**：
   - 每次保存配置时，应用会自动检查更新
   - 如果有新版本，会自动更新
   - 如果已是最新版本，会跳过更新

### 对于开发者

1. **发布新版本时**：
   - 更新 `CURRENT_VERSION` 常量
   - 更新 `FILE_VERSIONS` 中变化的文件版本号
   - 未变化的文件保持原版本号

2. **版本号规则**：
   - 使用语义化版本号（如 1.1.0）
   - 主版本号：不兼容的 API 修改
   - 次版本号：向下兼容的功能性新增
   - 修订号：向下兼容的问题修正

## 测试场景

### 场景 1：全新仓库
- **操作**：首次配置并保存
- **预期**：完整初始化所有文件，创建版本文件
- **验证**：检查所有文件都存在且版本正确

### 场景 2：旧仓库（无版本文件）
- **操作**：保存配置
- **预期**：完整更新所有文件，创建版本文件
- **验证**：构建成功，不再报错

### 场景 3：已更新仓库
- **操作**：保存配置
- **预期**：跳过更新，显示"已是最新版本"
- **验证**：不产生新的 commit

### 场景 4：部分文件过期
- **操作**：修改版本号后保存配置
- **预期**：只更新过期的文件
- **验证**：只有指定文件被更新

## 优势

1. **自动化**：无需手动删除文件，自动检测和更新
2. **智能化**：只更新需要的文件，不影响其他内容
3. **可追踪**：版本文件记录了所有文件的版本信息
4. **用户友好**：清晰的反馈消息，让用户知道发生了什么
5. **向后兼容**：旧仓库会自动升级到新版本

## 注意事项

1. **不影响日报内容**：更新只涉及网站和脚本文件，不会修改 `docs/**/*.md` 中的日报内容
2. **需要网络连接**：更新需要访问 GitHub API
3. **需要正确权限**：GitHub Token 需要有 repo 权限
4. **版本文件由应用管理**：不建议手动修改 `.daily-version.json`

## 故障排除

### 问题：更新失败
- **原因**：网络问题或权限不足
- **解决**：检查网络连接和 GitHub Token 权限

### 问题：版本检查失败
- **原因**：版本文件格式错误或不存在
- **解决**：应用会自动降级到完整更新模式

### 问题：部分文件更新失败
- **原因**：文件冲突或 API 限制
- **解决**：查看错误消息，手动修复或重试

## 版本历史

### v1.1.0 (2026-02-12)
- 引入版本管理机制
- 实现自动更新功能
- 修复数据加载器安全检查问题
- 优化用户反馈消息

### v1.0.0
- 初始版本
- 基础初始化功能
- 存在文件版本不同步问题

## 相关文档

- [完整使用流程](./完整使用流程.md)
- [日报仓库设置指南](./日报仓库设置指南.md)
- [常见问题](./常见问题.md)
