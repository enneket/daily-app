# 日报桌面应用 - 技术文档

## 项目概述

一个基于 Electron 的跨平台桌面应用，用于快速编写和提交日报到 GitHub 仓库。

## 技术架构

### 技术栈

- **Electron**: 跨平台桌面应用框架
- **React 18**: UI 框架
- **TypeScript**: 类型安全
- **Tailwind CSS**: 样式框架
- **Octokit**: GitHub API 客户端
- **electron-store**: 本地存储 GitHub 仓库连接信息
- **electron-builder**: 应用打包

### 项目结构

```
daily-report-app/
├── src/
│   ├── main/              # Electron 主进程
│   │   ├── main.ts
│   │   └── preload.ts
│   ├── renderer/          # React 渲染进程
│   │   ├── App.tsx
│   │   ├── components/
│   │   │   ├── MainEditor.tsx
│   │   │   └── Settings.tsx
│   │   ├── services/
│   │   │   └── github.ts
│   │   └── index.tsx
│   └── types/
│       └── index.ts
├── package.json
├── tsconfig.json
└── electron-builder.json
```

## 功能设计

### 1. 主界面 (MainEditor)

**布局**:
```
┌─────────────────────────────────┐
│ [设置]                          │
│                                 │
│  ┌───────────────────────────┐ │
│  │                           │ │
│  │   文本输入区域            │ │
│  │   (textarea)              │ │
│  │                           │ │
│  │                           │ │
│  └───────────────────────────┘ │
│                      [提交]     │
└─────────────────────────────────┘
```

**功能**:
- 多行文本输入
- Markdown 支持
- 提交后自动清空
- 提交状态提示

### 2. 设置页面 (Settings)

**本地存储（仓库连接信息）**:
```typescript
interface LocalConfig {
  githubToken: string;      // GitHub Personal Access Token
  repoOwner: string;        // 仓库所有者
  repoName: string;         // 仓库名称
  branch: string;           // 分支名（默认 main）
}
```

**GitHub 仓库配置文件（.config.json）**:
```typescript
interface RepoConfig {
  dailyReportPath: string;  // 日报存储路径模板，默认 "YYYY/MM/DD.md"
  timezone: string;         // 时区，默认 "Asia/Shanghai"
  dateFormat: string;       // 日期格式，默认 "YYYY-MM-DD"
  timeFormat: string;       // 时间格式，默认 "HH:mm"
}
```

**存储策略**:
- 本地存储：GitHub 仓库连接信息（Token、仓库名等）
- GitHub 存储：应用配置、日报数据
- 首次使用时配置本地连接信息
- 应用启动时从 GitHub 拉取配置和数据

**UI 元素**:
- GitHub Token 输入框（密码类型）
- 仓库所有者输入框
- 仓库名称输入框
- 分支名称输入框
- 保存按钮
- 测试连接按钮

### 3. GitHub 集成

#### 文件路径生成

```typescript
function generateFilePath(date: Date): string {
  const year = date.getFullYear();
  const month = String(date.getMonth() + 1).padStart(2, '0');
  const day = String(date.getDate()).padStart(2, '0');
  return `${year}/${month}/${day}.md`;
}
```

#### 提交逻辑

1. 获取当前日期
2. 生成文件路径：`YYYY/MM/DD.md`
3. 尝试读取现有文件内容
4. 如果文件存在，追加新内容（带时间戳）
5. 如果文件不存在，创建新文件
6. 提交到 GitHub

#### 内容格式

```markdown
# 2026-02-11 日报

## 10:30
- 完成了功能 A 的开发
- 修复了 Bug B

## 14:20
- 参加了项目会议
- 更新了文档

## 17:00
- 代码审查
- 部署测试环境
```

### 4. API 实现

```typescript
import { Octokit } from '@octokit/rest';

class GitHubService {
  private octokit: Octokit;
  private config: LocalConfig;
  private repoConfig: RepoConfig;
  
  // 初始化：加载本地配置和 GitHub 配置
  async initialize(): Promise<void> {
    // 从本地读取 GitHub 连接信息
    this.config = await this.loadLocalConfig();
    
    // 从 GitHub 拉取应用配置
    this.repoConfig = await this.loadRepoConfig();
  }
  
  // 从 GitHub 加载配置文件
  async loadRepoConfig(): Promise<RepoConfig> {
    try {
      const { data } = await this.octokit.repos.getContent({
        owner: this.config.repoOwner,
        repo: this.config.repoName,
        path: '.config.json',
        ref: this.config.branch,
      });
      
      if ('content' in data) {
        const content = Buffer.from(data.content, 'base64').toString();
        return JSON.parse(content);
      }
    } catch (error) {
      // 配置文件不存在，创建默认配置
      const defaultConfig: RepoConfig = {
        dailyReportPath: 'YYYY/MM/DD.md',
        timezone: 'Asia/Shanghai',
        dateFormat: 'YYYY-MM-DD',
        timeFormat: 'HH:mm',
      };
      
      await this.createRepoConfig(defaultConfig);
      return defaultConfig;
    }
  }
  
  // 提交日报
  async submitReport(content: string): Promise<void> {
    const filePath = generateFilePath(new Date());
    const timestamp = new Date().toLocaleTimeString('zh-CN', { 
      hour: '2-digit', 
      minute: '2-digit' 
    });
    
    // 获取现有文件内容
    let existingContent = '';
    let sha: string | undefined;
    
    try {
      const { data } = await this.octokit.repos.getContent({
        owner: this.config.repoOwner,
        repo: this.config.repoName,
        path: filePath,
        ref: this.config.branch,
      });
      
      if ('content' in data) {
        existingContent = Buffer.from(data.content, 'base64').toString();
        sha = data.sha;
      }
    } catch (error) {
      // 文件不存在，创建新文件
      existingContent = `# ${new Date().toLocaleDateString('zh-CN')} 日报\n\n`;
    }
    
    // 追加新内容
    const newContent = `${existingContent}\n## ${timestamp}\n${content}\n`;
    
    // 提交到 GitHub
    await this.octokit.repos.createOrUpdateFileContents({
      owner: this.config.repoOwner,
      repo: this.config.repoName,
      path: filePath,
      message: `Update daily report: ${new Date().toLocaleDateString('zh-CN')}`,
      content: Buffer.from(newContent).toString('base64'),
      branch: this.config.branch,
      sha: sha,
    });
  }
  
  // 获取今天的日报内容
  async getTodayReport(): Promise<string> {
    const filePath = generateFilePath(new Date());
    
    try {
      const { data } = await this.octokit.repos.getContent({
        owner: this.config.repoOwner,
        repo: this.config.repoName,
        path: filePath,
        ref: this.config.branch,
      });
      
      if ('content' in data) {
        return Buffer.from(data.content, 'base64').toString();
      }
    } catch (error) {
      // 今天还没有日报
      return '';
    }
  }
}
```

## 数据流程

### 首次使用
1. 用户打开应用
2. 提示配置 GitHub 连接信息（Token、仓库名等）
3. 验证连接并保存到本地（electron-store）
4. 从 GitHub 拉取 `.config.json`（如果不存在则创建默认配置）
5. 进入主界面

### 日常使用
1. 应用启动，读取本地 GitHub 连接信息
2. 从 GitHub 拉取配置文件 `.config.json`
3. 从 GitHub 拉取今天的日报内容（如果存在）
4. 用户编写日报并提交
5. 追加到 GitHub 对应日期的文件

### 数据存储位置

**本地（electron-store）**:
- GitHub Token
- 仓库所有者
- 仓库名称
- 分支名称

**GitHub 仓库**:
- `.config.json` - 应用配置
- `YYYY/MM/DD.md` - 日报数据

## 安全考虑

1. **Token 存储**: 使用 electron-store 加密存储在本地
2. **Token 验证**: 设置页面提供测试连接功能
3. **错误处理**: 网络错误、权限错误的友好提示
4. **Token 权限**: 只需要 `repo` 权限
5. **配置同步**: 应用启动时从 GitHub 拉取最新配置

## 用户体验优化

1. **快捷键支持**:
   - `Cmd/Ctrl + Enter`: 提交日报
   - `Cmd/Ctrl + ,`: 打开设置

2. **状态提示**:
   - 提交中：显示加载动画
   - 提交成功：显示成功提示（2秒后消失）
   - 提交失败：显示错误信息

3. **历史记录**: 从 GitHub 拉取当天的日报内容显示在界面上

## 打包配置

### Mac
- DMG 安装包
- 支持 Intel 和 Apple Silicon

### Windows
- NSIS 安装程序
- 支持 x64

## 开发命令

```bash
# 安装依赖
npm install

# 开发模式
npm run dev

# 打包 Mac
npm run build:mac

# 打包 Windows
npm run build:win

# 打包所有平台
npm run build
```

## GitHub Token 获取步骤

1. 访问 GitHub Settings → Developer settings → Personal access tokens
2. 点击 "Generate new token (classic)"
3. 选择权限：`repo` (Full control of private repositories)
4. 生成并复制 token
5. 在应用设置中粘贴 token

## GitHub 仓库结构

```
daily-reports/                    # 仓库根目录
├── .config.json                  # 应用配置文件
├── 2026/                         # 年份目录
│   ├── 01/                       # 月份目录
│   │   ├── 01.md
│   │   ├── 02.md
│   │   └── ...
│   ├── 02/
│   │   ├── 01.md
│   │   ├── 11.md                 # 今天的日报
│   │   └── ...
│   └── ...
└── README.md                     # 仓库说明
```

## 未来扩展

- [ ] 支持 Markdown 预览
- [ ] 支持模板功能
- [ ] 支持多个仓库配置
- [ ] 支持周报、月报生成
- [ ] 支持导出功能
- [ ] 支持查看历史日报（日历视图）
- [ ] 支持搜索功能
