# v1.2.5 动态配置支持

## 功能说明

支持根据用户在桌面应用中配置的仓库信息，动态生成 VitePress 配置和相关文件，无需手动修改配置文件。

## 问题背景

之前的版本中，以下配置是写死的：
- VitePress 的 `base` 路径（仓库名）
- GitHub 图标链接（用户名和仓库名）
- Sitemap 主机名（用户名和仓库名）
- 日报索引中的路径前缀（仓库名）

这导致不同用户使用时需要手动修改多个配置文件，容易出错且不够灵活。

## 解决方案

### 占位符系统

在模板文件中使用占位符，在初始化时自动替换为用户的实际配置。

#### 支持的占位符

- `{{REPO_OWNER}}` - 仓库所有者（GitHub 用户名）
- `{{REPO_NAME}}` - 仓库名称

#### 使用占位符的文件

1. **site/.vitepress/config.ts**
   ```typescript
   base: '/{{REPO_NAME}}/',
   
   socialLinks: [
     { icon: 'github', link: 'https://github.com/{{REPO_OWNER}}/{{REPO_NAME}}' }
   ],
   
   sitemap: {
     hostname: 'https://{{REPO_OWNER}}.github.io/{{REPO_NAME}}'
   }
   ```

2. **scripts/generate-index.js**
   ```javascript
   path: `/{{REPO_NAME}}/docs/${year}/${month}/${day}`
   ```

### 实现原理

#### 1. 占位符替换方法

在 `github-service.ts` 中添加 `replacePlaceholders()` 方法：

```typescript
private replacePlaceholders(content: string): string {
  return content
    .replace(/\{\{REPO_OWNER\}\}/g, this.config.repoOwner)
    .replace(/\{\{REPO_NAME\}\}/g, this.config.repoName);
}
```

#### 2. 文件上传时自动替换

在 `updateRepoFiles()` 方法中，读取文件内容后进行替换：

```typescript
for (const file of filesToCopy) {
  if (filesToUpdate.includes(file.remote)) {
    try {
      let content = this.readLocalFile(file.local);
      
      // 对需要替换占位符的文件进行处理
      if (file.remote === 'site/.vitepress/config.ts' || 
          file.remote === 'scripts/generate-index.js') {
        content = this.replacePlaceholders(content);
      }
      
      files.push({ path: file.remote, content });
    } catch (error) {
      console.warn(`跳过文件 ${file.local}:`, error);
    }
  }
}
```

## 使用示例

### 用户配置

用户在桌面应用中填写：
- 仓库所有者：`enneket`
- 仓库名称：`daily`

### 自动生成的配置

**VitePress 配置**：
```typescript
base: '/daily/',

socialLinks: [
  { icon: 'github', link: 'https://github.com/enneket/daily' }
],

sitemap: {
  hostname: 'https://enneket.github.io/daily'
}
```

**索引路径**：
```javascript
path: `/daily/docs/2026/02/12`
```

## 优点

### 1. 自动化

用户只需在桌面应用中配置一次，所有相关文件自动生成正确的配置。

### 2. 灵活性

支持任意用户名和仓库名，不需要修改代码。

### 3. 一致性

确保所有配置文件中的用户名和仓库名保持一致。

### 4. 易维护

如果需要添加新的配置项，只需：
1. 在模板文件中添加占位符
2. 在替换列表中添加该文件

### 5. 向后兼容

不影响已有功能，现有用户重新初始化即可获得新功能。

## 修改的文件

- `site/.vitepress/config.ts` - 使用占位符
- `scripts/generate-index.js` - 使用占位符
- `src/main/github-service.ts` - 添加替换逻辑

## 版本信息

- 版本号：v1.2.5
- 更新内容：
  - 添加占位符系统
  - 支持动态配置 VitePress
  - 支持动态配置索引路径

## 使用方法

### 对于新用户

1. 下载并安装桌面应用 v1.2.5
2. 填写 GitHub 配置（用户名、仓库名等）
3. 点击"保存并初始化"
4. 所有配置自动生成，无需手动修改

### 对于已有用户

1. 更新桌面应用到 v1.2.5
2. 打开应用，点击"保存并初始化"
3. 应用会自动更新配置文件
4. 等待 GitHub Actions 构建完成
5. 刷新网站，验证配置正确

## 验证方法

### 1. 检查 GitHub 图标

访问日报网站，点击右上角的 GitHub 图标，应该跳转到你的日报仓库。

### 2. 检查链接

从首页、日历、归档页面点击日报链接，应该能正确跳转到详情页。

### 3. 检查 Sitemap

访问：`https://你的用户名.github.io/仓库名/sitemap.xml`

应该能看到正确的 URL 列表。

## 扩展性

### 添加新占位符

如果需要添加新的占位符（如分支名、作者名等）：

1. **定义占位符**：如 `{{BRANCH_NAME}}`

2. **在模板中使用**：
   ```typescript
   branch: '{{BRANCH_NAME}}'
   ```

3. **添加替换规则**：
   ```typescript
   private replacePlaceholders(content: string): string {
     return content
       .replace(/\{\{REPO_OWNER\}\}/g, this.config.repoOwner)
       .replace(/\{\{REPO_NAME\}\}/g, this.config.repoName)
       .replace(/\{\{BRANCH_NAME\}\}/g, this.config.branch);  // 新增
   }
   ```

### 添加新文件

如果需要对新文件进行占位符替换：

```typescript
if (file.remote === 'site/.vitepress/config.ts' || 
    file.remote === 'scripts/generate-index.js' ||
    file.remote === '新文件路径') {  // 新增
  content = this.replacePlaceholders(content);
}
```

## 注意事项

### 1. 占位符格式

- 使用双花括号：`{{PLACEHOLDER}}`
- 全大写，下划线分隔：`{{REPO_NAME}}`
- 避免与 Vue/VitePress 的模板语法冲突

### 2. 特殊字符

如果用户名或仓库名包含特殊字符，确保在 URL 中正确编码。

### 3. 大小写敏感

GitHub 用户名和仓库名是大小写敏感的，确保配置正确。

## 相关文档

- [动态替换 VitePress 配置占位符方案](../plans/2026-02-12-动态替换VitePress配置占位符.md)
- [v1.2.4 修复详情页链接 base 前缀](./v1.2.4修复详情页链接base前缀.md)
- [v1.0.0 正式版发布](./v1.0.0正式版发布.md)

## 技术细节

### 正则表达式

使用全局替换确保所有占位符都被替换：
```typescript
.replace(/\{\{REPO_OWNER\}\}/g, this.config.repoOwner)
```

`/g` 标志表示全局替换，替换所有匹配项。

### 性能考虑

- 只对需要替换的文件进行处理
- 替换操作在内存中完成，不影响本地文件
- 每个文件只替换一次

### 错误处理

如果占位符未被替换（如配置缺失），文件中会保留原始占位符，便于调试。

## 未来改进

可能的改进方向：

1. **配置验证**：在替换前验证配置的有效性
2. **预览功能**：显示替换后的配置预览
3. **更多占位符**：支持更多自定义配置项
4. **模板系统**：支持更复杂的模板语法
