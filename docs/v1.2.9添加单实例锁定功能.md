# v1.2.9 添加单实例锁定功能

## 功能描述

添加了单实例锁定功能，确保应用同时只能运行一个实例。当用户尝试打开第二个实例时，会自动激活已存在的窗口。

## 功能特性

### 1. 单实例限制

- 应用启动时会请求单实例锁
- 如果已有实例在运行，新实例会自动退出
- 用户无法同时打开多个应用窗口

### 2. 窗口聚焦

当用户尝试启动第二个实例时：
- 如果主窗口被最小化，会自动恢复
- 主窗口会自动获得焦点
- 用户体验流畅，无需手动切换窗口

## 实现细节

### 使用 Electron API

```typescript
// 请求单实例锁
const gotTheLock = app.requestSingleInstanceLock();

if (!gotTheLock) {
  // 如果获取锁失败，说明已有实例在运行，退出当前实例
  app.quit();
} else {
  // 当第二个实例尝试启动时触发
  app.on('second-instance', (_event, _commandLine, _workingDirectory) => {
    // 如果主窗口存在，聚焦它
    if (mainWindow) {
      if (mainWindow.isMinimized()) {
        mainWindow.restore();
      }
      mainWindow.focus();
    }
  });
  
  // 正常启动应用
  app.whenReady().then(() => {
    createWindow();
  });
}
```

### 工作流程

1. **首次启动**：
   - 请求单实例锁成功
   - 正常创建窗口并运行

2. **尝试第二次启动**：
   - 请求单实例锁失败
   - 触发第一个实例的 `second-instance` 事件
   - 第二个实例自动退出

3. **窗口激活**：
   - 检查主窗口是否最小化
   - 如果最小化，恢复窗口
   - 聚焦主窗口

## 使用场景

### 防止数据冲突

- 避免多个实例同时修改日报数据
- 确保 GitHub 同步的一致性

### 改善用户体验

- 用户点击快捷方式时，直接激活已打开的窗口
- 避免用户困惑（不知道哪个是当前窗口）

### 资源优化

- 减少内存占用
- 避免重复的后台进程

## 测试方法

### 开发模式测试

1. 启动应用：`npm run dev:electron`
2. 再次运行：`npm run dev:electron`
3. 观察：第二个实例应该自动退出，第一个窗口获得焦点

### 打包后测试

1. 打包应用：`npm run package:win`
2. 双击可执行文件启动应用
3. 再次双击可执行文件
4. 观察：已打开的窗口应该获得焦点

### 最小化测试

1. 启动应用
2. 最小化窗口
3. 再次尝试启动应用
4. 观察：窗口应该自动恢复并获得焦点

## 技术说明

### API 说明

- `app.requestSingleInstanceLock()`：请求单实例锁，返回布尔值
- `app.on('second-instance', callback)`：当第二个实例尝试启动时触发
- `mainWindow.isMinimized()`：检查窗口是否最小化
- `mainWindow.restore()`：恢复最小化的窗口
- `mainWindow.focus()`：聚焦窗口

### 平台兼容性

- Windows: 完全支持
- macOS: 完全支持
- Linux: 完全支持

## 影响范围

- 应用启动流程
- 多实例行为
- 窗口管理

## 版本信息

- 版本号：v1.2.9
- 发布日期：2026-02-24
- 依赖版本：Electron 28.x
