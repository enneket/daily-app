# v1.2.6 修复统计页面渲染

## 问题描述

统计页面显示原始 HTML 代码而不是渲染后的内容：

```html
<div class="stat-card">
  <div class="stat-value">1</div>
  <div class="stat-label">今年日报</div>
</div>
```

用户看到的是这些 HTML 标签，而不是格式化后的统计卡片。

## 问题原因

VitePress 的服务端渲染（SSR）与客户端 hydration 不匹配，导致 Vue 组件无法正确渲染。

### 技术背景

VitePress 使用 SSR（Server-Side Rendering）：
1. **构建时**：在服务器端预渲染 HTML
2. **访问时**：发送预渲染的 HTML 给浏览器
3. **Hydration**：客户端 JavaScript 接管，使页面变为交互式

如果服务端和客户端的状态不一致，hydration 会失败，导致页面显示异常。

## 解决方案

使用 VitePress 的 `<ClientOnly>` 组件包裹统计页面内容。

### 修改内容

**文件**：`site/stats.md`

**修改前**：
```vue
# 总体统计

<script setup>
import { data as reports } from './.vitepress/reports-index.data';
import { data as stats } from './.vitepress/stats.data';
...
</script>

<div class="stats-container">
  ...
</div>
```

**修改后**：
```vue
# 总体统计

<ClientOnly>
<script setup>
import { data as reports } from './.vitepress/reports-index.data';
import { data as stats } from './.vitepress/stats.data';
...
</script>

<div class="stats-container">
  ...
</div>
</ClientOnly>
```

### ClientOnly 组件

`<ClientOnly>` 是 VitePress 提供的特殊组件：
- **跳过 SSR**：服务端渲染时不处理内部内容
- **客户端渲染**：只在浏览器中渲染
- **避免不匹配**：防止 SSR/客户端状态不一致

## 工作原理

### 1. 构建阶段（SSR）

```
服务端渲染 → 遇到 <ClientOnly> → 跳过内容 → 生成占位符
```

生成的 HTML：
```html
<div class="vp-client-only">
  <!-- 占位符 -->
</div>
```

### 2. 浏览器加载

```
加载 HTML → 加载 JavaScript → 执行 hydration → 渲染 ClientOnly 内容
```

最终显示：
```html
<div class="stats-container">
  <div class="stat-card">
    <div class="stat-value">1</div>
    <div class="stat-label">今年日报</div>
  </div>
</div>
```

## 效果对比

### 修复前

- ❌ 显示原始 HTML 代码
- ❌ Vue 组件不渲染
- ❌ 数据不显示
- ❌ 样式不生效

### 修复后

- ✅ 正确显示统计卡片
- ✅ Vue 组件正常渲染
- ✅ 数据正确显示
- ✅ 样式正常应用

## 性能影响

### 首屏加载

使用 `<ClientOnly>` 后：
1. **首屏**：显示空白或加载中（很短暂）
2. **JavaScript 加载后**：显示完整内容
3. **用户体验**：通常感知不到延迟

### SEO 影响

- 统计数据不会被搜索引擎索引
- 但统计页面本身不需要 SEO
- 对整体 SEO 无影响

## 版本信息

- 版本号：v1.2.6
- 更新内容：使用 ClientOnly 修复统计页面渲染问题
- 修改文件：
  - `site/stats.md` - 添加 ClientOnly 包裹
  - `src/main/github-service.ts` - 更新版本号

## 使用方法

### 对于新用户

使用 v1.2.6 或更高版本，统计页面会自动正常显示。

### 对于已有用户

1. 更新桌面应用到 v1.2.6
2. 打开应用，点击"保存并初始化"
3. 等待 GitHub Actions 构建完成（2-5 分钟）
4. 刷新统计页面，验证显示正常

## 验证方法

访问统计页面：`https://你的用户名.github.io/仓库名/stats`

应该看到：
- ✅ 格式化的统计卡片
- ✅ 总日报数、连续天数等数据
- ✅ 按年/按月统计图表
- ✅ 时间跨度信息

如果仍然看到 HTML 代码：
1. 清除浏览器缓存（Ctrl+F5）
2. 检查 GitHub Actions 是否构建成功
3. 检查浏览器控制台是否有 JavaScript 错误

## 技术细节

### 为什么统计页面需要 ClientOnly？

统计页面的特点：
1. **复杂的数据处理**：对象转数组、排序等
2. **动态计算**：百分比、条形图宽度等
3. **响应式数据**：Vue 的响应式系统

这些特性在 SSR 时容易出现问题。

### 其他页面为什么不需要？

- **首页**：数据简单，直接显示
- **日历页**：已简化（v1.2.0），使用静态渲染
- **归档页**：已简化（v1.2.0），使用静态渲染

只有统计页面因为数据处理复杂，需要 ClientOnly。

## 历史问题

### v1.2.1 的修复

v1.2.1 修复了统计页面对象遍历问题：
- 将 `v-for` 遍历对象改为遍历数组
- 解决了部分渲染问题

但 SSR hydration 问题仍然存在，v1.2.6 彻底解决。

### v1.2.0 的简化

v1.2.0 简化了日历和归档页面：
- 移除复杂的交互逻辑
- 使用静态渲染
- 避免 SSR 问题

统计页面因为需要展示复杂数据，无法完全简化，所以使用 ClientOnly。

## 最佳实践

### 何时使用 ClientOnly？

适用场景：
- 复杂的数据处理和计算
- 依赖浏览器 API（window、document）
- 第三方库不支持 SSR
- 动态内容频繁变化

不适用场景：
- 静态内容
- 需要 SEO 的内容
- 首屏关键内容

### 替代方案

如果不想使用 ClientOnly：
1. **简化逻辑**：减少复杂的计算和响应式
2. **静态生成**：构建时生成静态 HTML
3. **延迟加载**：使用 `onMounted` 钩子

## 相关文档

- [修复统计页面 ClientOnly 渲染方案](../plans/2026-02-12-修复统计页面ClientOnly渲染.md)
- [v1.2.1 修复统计页面对象遍历问题](./v1.2.1修复统计页面对象遍历问题.md)
- [v1.2.0 简化页面实现](./v1.2.0简化页面实现.md)
- [v1.1.3 修复 Vue 组件渲染问题](./v1.1.3修复Vue组件渲染问题.md)

## 故障排除

### 问题：统计页面仍然显示 HTML 代码

**可能原因**：
1. 浏览器缓存
2. GitHub Actions 构建未完成
3. JavaScript 加载失败

**解决方法**：
1. 清除缓存：Ctrl+F5
2. 检查构建状态
3. 查看浏览器控制台错误

### 问题：统计页面显示空白

**可能原因**：
1. 数据文件不存在
2. JavaScript 错误
3. 网络问题

**解决方法**：
1. 检查 `stats.json` 是否生成
2. 查看控制台错误
3. 重新构建

### 问题：数据不正确

**可能原因**：
1. 索引未更新
2. 日报文件路径错误
3. 数据格式问题

**解决方法**：
1. 重新运行 `generate-index.js`
2. 检查日报文件位置
3. 验证 JSON 格式

## 总结

v1.2.6 通过使用 `<ClientOnly>` 组件，彻底解决了统计页面的渲染问题。这是一个简单但有效的解决方案，确保统计页面在所有情况下都能正确显示。
