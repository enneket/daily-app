# v1.1.1 修复构建缓存问题

## 问题描述

v1.1.0 虽然成功更新了日报仓库的所有文件，但 GitHub Actions 构建时仍然报错 `Cannot read properties of undefined (reading 'day')`。

**根本原因**：GitHub Actions 使用了缓存的旧文件，导致即使源文件已更新，构建时仍使用旧版本。

## 解决方案

在 GitHub Actions workflow 中添加清理缓存步骤，确保每次构建都使用最新的文件。

### 修改内容

在 `.github/workflows/deploy-site.yml` 的构建步骤中，在"安装依赖"之前添加：

```yaml
- name: 清理缓存
  run: |
    rm -rf site/.vitepress/cache
    rm -rf site/.vitepress/dist
    rm -f site/.vitepress/reports-index.json
    rm -f site/.vitepress/stats.json
```

同时在 `on.push.paths` 中添加 `site/**`，确保 site 目录下的文件变化也会触发构建。

### 完整的 workflow 构建部分

```yaml
jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
      - name: 检出代码
        uses: actions/checkout@v4
      
      - name: 设置 Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - name: 清理缓存
        run: |
          rm -rf site/.vitepress/cache
          rm -rf site/.vitepress/dist
          rm -f site/.vitepress/reports-index.json
          rm -f site/.vitepress/stats.json
      
      - name: 安装依赖
        run: npm install
      
      - name: 生成日报索引
        run: node scripts/generate-index.js
      
      - name: 构建网站
        run: npm run build:site
```

## 使用方法

1. **重新打包桌面应用**（包含 v1.1.1 的修改）
2. **运行应用，进入设置**
3. **点击"保存并初始化"**（会更新 workflow 文件到 v1.1.1）
4. **触发构建**：
   - 方法 1：提交一篇新日报
   - 方法 2：在 GitHub Actions 页面手动触发 workflow
5. **验证构建成功**

## 技术细节

### 为什么需要清理缓存？

VitePress 会在 `site/.vitepress/cache` 目录缓存编译结果。当源文件更新但缓存未清理时，VitePress 可能使用旧的缓存文件，导致构建错误。

### 清理的文件

- `site/.vitepress/cache` - VitePress 编译缓存
- `site/.vitepress/dist` - 构建输出目录
- `site/.vitepress/reports-index.json` - 日报索引（由脚本生成）
- `site/.vitepress/stats.json` - 统计数据（由脚本生成）

### 为什么不在 .gitignore 中排除？

这些文件已经在 `.gitignore` 中排除，不会提交到仓库。但 GitHub Actions 的运行环境是全新的，每次都会 checkout 代码，所以理论上不应该有缓存问题。

**实际情况**：可能是 VitePress 或 Node.js 的某些机制导致了缓存问题，显式清理可以确保万无一失。

## 修改的文件

- `src/main/github-service.ts` - 更新 workflow 模板，添加清理缓存步骤

## 版本历史

### v1.1.1 (2026-02-12)
- 添加构建前清理缓存步骤
- 修复 GitHub Actions 缓存导致的构建错误
- 在 workflow 触发条件中添加 `site/**` 路径

### v1.1.0 (2026-02-12)
- 引入版本管理机制
- 实现自动更新功能
- 修复数据加载器安全检查问题

## 验证方法

构建成功的标志：
1. GitHub Actions 显示绿色勾号 ✅
2. 没有 `Cannot read properties of undefined` 错误
3. 网站可以正常访问

## 如果还是失败

如果清理缓存后仍然失败，可能的原因：

1. **文件未真正更新**：检查日报仓库的文件内容是否是最新版本
2. **Node.js 版本问题**：确认 workflow 使用 Node.js 20
3. **依赖问题**：检查 `package.json` 中的 VitePress 版本

## 相关文档

- [版本管理和自动更新机制](./版本管理和自动更新机制.md)
- [v1.1.0 更新说明](./v1.1.0更新说明.md)
