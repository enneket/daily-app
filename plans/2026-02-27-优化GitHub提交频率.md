# 优化 GitHub 提交频率

## 背景

当前应用每次用户提交日报时都会立即推送到 GitHub，这会导致：
1. 频繁的网络请求，影响性能
2. 每次提交都触发 GitHub Actions，浪费 CI/CD 资源
3. 用户体验不佳，需要等待网络响应

## 目标

优化提交策略，采用批量提交和定时提交的方式，减少网络请求次数，提高应用性能和用户体验。

## 需求

### 功能需求

1. **批量提交**
   - 用户提交日报时先保存到本地缓存
   - 累积满 10 个提交后自动推送到 GitHub
   - 提交成功后清除缓存和计数

2. **定时提交**
   - 有未提交内容时，每 4 小时自动推送一次
   - 后台定时检查（每小时检查一次）
   - 避免长时间不同步

3. **手动提交**
   - 提供"立即提交"按钮
   - 用户可随时手动触发提交
   - 显示提交结果反馈

4. **状态显示**
   - 实时显示待提交数量
   - 显示距离下次自动提交的剩余时间
   - 提供清晰的视觉反馈

### 技术需求

1. **本地存储**
   - 使用 electron-store 存储缓存数据
   - 存储待提交计数和最后提交时间
   - 存储完整的日报内容和文件 SHA

2. **IPC 通信**
   - 新增 `get-commit-status` 获取提交状态
   - 新增 `manual-push` 手动触发提交
   - 更新 `submit-report` 改为本地缓存

3. **定时任务**
   - 应用启动时启动定时器
   - 每小时检查一次是否需要自动提交
   - 满足条件时自动推送

## 实现方案

### 1. 数据结构

```typescript
// electron-store 存储结构
{
  cachedReport: {
    filePath: string,    // 文件路径
    content: string,     // 完整内容
    sha?: string        // GitHub 文件 SHA
  },
  pendingCommits: number,  // 待提交计数
  lastPushTime: number     // 最后提交时间戳
}
```

### 2. 提交策略

```typescript
class GitHubService {
  private readonly BATCH_SIZE = 10;  // 批量大小
  private readonly AUTO_PUSH_INTERVAL = 4 * 60 * 60 * 1000;  // 4小时
  
  // 检查是否需要自动提交
  private shouldAutoPush(): boolean {
    // 策略1: 累积满10个
    if (pendingCommits >= BATCH_SIZE) return true;
    
    // 策略2: 超过4小时且有未提交内容
    if (pendingCommits > 0 && 距离上次提交 >= 4小时) return true;
    
    return false;
  }
}
```

### 3. 文件修改

#### src/main/github-service.ts
- 添加 `store` 参数到构造函数
- 添加 `BATCH_SIZE` 和 `AUTO_PUSH_INTERVAL` 常量
- 修改 `submitReport()` 先保存到本地
- 新增 `getCommitStatus()` 获取状态
- 新增 `shouldAutoPush()` 检查条件
- 新增 `pushToGitHub()` 推送到远程
- 新增 `manualPush()` 手动提交

#### src/main/main.ts
- 修改所有 `new GitHubServiceClass(config)` 为 `new GitHubServiceClass(config, store)`
- 新增 `get-commit-status` IPC handler
- 新增 `manual-push` IPC handler
- 添加定时检查（每小时）

#### src/main/preload.ts
- 暴露 `getCommitStatus` API
- 暴露 `manualPush` API

#### src/renderer/types.ts
- 新增 `CommitStatus` 接口
- 新增 `ManualPushResult` 接口
- 更新 `ElectronAPI` 接口

#### src/renderer/components/MainEditor.tsx
- 添加 `commitStatus` 状态
- 添加 `loadCommitStatus()` 函数
- 添加 `handleManualPush()` 函数
- 添加提交状态显示区域
- 添加"立即提交"按钮
- 每分钟自动更新状态

### 4. UI 设计

```
┌─────────────────────────────────────┐
│ 📦 待提交：3 个更新                    │
│ 1 小时 30 分钟后自动提交               │
│                    [立即提交] 按钮     │
└─────────────────────────────────────┘
```

## 测试计划

### 单元测试
1. `shouldAutoPush()` 逻辑测试
2. `getCommitStatus()` 返回值测试
3. `manualPush()` 功能测试

### 集成测试
1. 提交 1-9 次，验证不推送
2. 提交第 10 次，验证自动推送
3. 等待 4 小时，验证定时推送
4. 手动触发，验证立即推送

### 边界测试
1. 网络断开时的行为
2. GitHub API 错误处理
3. 应用重启后状态恢复

## 风险评估

### 技术风险
- **数据丢失**：本地缓存可能因应用崩溃丢失
  - 缓解：使用 electron-store 持久化存储
  
- **数据冲突**：多设备使用可能产生冲突
  - 缓解：文档说明建议单设备使用

### 用户体验风险
- **延迟同步**：用户可能不理解为什么没有立即推送
  - 缓解：清晰的状态显示和提示信息

## 时间估算

- 后端实现：2 小时
- 前端实现：1.5 小时
- 测试验证：1 小时
- 文档编写：0.5 小时
- **总计**：5 小时

## 验收标准

1. ✅ 累积 10 个提交后自动推送
2. ✅ 4 小时后自动推送未提交内容
3. ✅ 手动提交按钮正常工作
4. ✅ 状态显示准确
5. ✅ 构建无错误
6. ✅ 文档完整

## 后续优化

1. 允许用户自定义批量大小和时间间隔
2. 添加冲突检测和合并策略
3. 支持离线模式，网络恢复后自动同步
4. 添加提交历史记录

## 参考资料

- [Electron Store 文档](https://github.com/sindresorhus/electron-store)
- [GitHub API 文档](https://docs.github.com/en/rest)
- [语义化版本规范](https://semver.org/lang/zh-CN/)
